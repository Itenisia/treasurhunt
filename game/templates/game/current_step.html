{% extends 'game/base.html' %}

{% block content %}
<div class="row justify-content-center text-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h3>Étape {{ step_number|add:"1" }}</h3>
            </div>
            <div class="card-body py-5">
                <h5 class="card-title text-muted mb-4">Votre indice :</h5>
                <p class="display-6 fw-bold text-primary">{{ clue }}</p>

                <hr class="my-4">

                <p class="lead">Trouvez le QR Code caché et scannez-le !</p>
                <p class="text-muted small">Score actuel : {{ progress.total_points }} pts</p>

                <div class="d-grid gap-2 mt-4">
                    <a href="{% url 'game:leaderboard' progress.hunt.id %}" class="btn btn-outline-secondary">Voir le
                        classement</a>
                </div>

                <hr class="my-4">
                <div class="text-start">
                    <h5 class="mb-3">Scanner un QR Code</h5>
                    <p class="text-muted small">Activez la caméra, passez en plein écran, puis pointez vers le QR Code.</p>
                    <div class="d-flex gap-2 mb-2">
                        <button id="qr-start" class="btn btn-dark btn-sm">Activer la caméra</button>
                        <button id="qr-stop" class="btn btn-outline-secondary btn-sm d-none">Arrêter</button>
                    </div>
                    <div id="qr-reader" class="rounded border" style="width:100%;max-width:480px;margin:auto;"></div>
                    <div id="qr-status" class="text-muted small mt-2"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="qr-overlay" class="qr-overlay d-none">
    <div class="qr-overlay-inner">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-white">Mode plein écran</span>
            <button id="qr-close" class="btn btn-outline-light btn-sm">Revenir</button>
        </div>
        <div id="qr-reader-full" class="qr-reader-full rounded"></div>
        <div id="qr-status-full" class="text-white small mt-2"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/html5-qrcode" defer></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const startBtn = document.getElementById('qr-start');
    const stopBtn = document.getElementById('qr-stop');
    const statusEl = document.getElementById('qr-status');
    const readerContainerId = 'qr-reader';
    const overlay = document.getElementById('qr-overlay');
    const overlayReaderId = 'qr-reader-full';
    const overlayStatus = document.getElementById('qr-status-full');
    const overlayClose = document.getElementById('qr-close');
    let scanner = null;
    const scanTemplate = "{% url 'game:scan_qr' '00000000-0000-0000-0000-000000000000' %}";
    const scanPrefix = scanTemplate.replace('00000000-0000-0000-0000-000000000000/', '');

    const uuidRegex = /[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}/i;

    const formatStatus = (text, isError = false, full = false) => {
        statusEl.textContent = text;
        statusEl.classList.toggle('text-danger', isError);
        if (full && overlayStatus) {
            overlayStatus.textContent = text;
            overlayStatus.classList.toggle('text-danger', isError);
        }
    };

    const extractToken = (raw) => {
        try {
            const url = new URL(raw);
            const matchFromPath = url.pathname.match(uuidRegex);
            if (matchFromPath) return matchFromPath[0];
        } catch (_) {
            // Not a full URL, fall back to regex on raw text
        }
        const match = raw.match(uuidRegex);
        return match ? match[0] : null;
    };

    const stopScanner = async () => {
        if (!scanner) return;
        try {
            await scanner.stop();
        } catch (e) {
            // ignore stop errors
        }
        scanner.clear();
        scanner = null;
        startBtn.classList.remove('d-none');
        stopBtn.classList.add('d-none');
        if (overlay) {
            overlay.classList.add('d-none');
        }
        if (document.fullscreenElement) {
            document.exitFullscreen().catch(() => {});
        }
        formatStatus('Caméra arrêtée.', false, true);
    };

    const onScanSuccess = async (decodedText) => {
        const token = extractToken(decodedText);
        if (!token) {
            formatStatus("QR détecté mais format inattendu.", true);
            return;
        }
        formatStatus("QR détecté, redirection en cours...", false, true);
        await stopScanner();
        window.location.href = `${scanPrefix}${token}/`;
    };

    const onScanFailure = (err) => {
        // Ignorer les erreurs fréquentes du scanner pour éviter le spam de logs
        if (typeof err === 'string' && err.toLowerCase().includes('not found')) {
            return;
        }
    };

    const startScanner = () => {
        if (scanner) return;
        if (!window.Html5Qrcode) {
            formatStatus("Bibliothèque de scan non chargée.", true);
            return;
        }
        const containerId = overlay ? overlayReaderId : readerContainerId;
        const statusFull = overlay ? true : false;
        scanner = new Html5Qrcode(containerId);
        if (overlay) {
            overlay.classList.remove('d-none');
            overlayStatus.textContent = '';
            overlay.requestFullscreen?.().catch(() => {});
        }
        scanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            onScanSuccess,
            onScanFailure
        ).then(() => {
            startBtn.classList.add('d-none');
            stopBtn.classList.remove('d-none');
            formatStatus("Caméra active. Scannez le QR Code.", false, statusFull);
        }).catch((err) => {
            scanner = null;
            if (overlay) {
                overlay.classList.add('d-none');
            }
            formatStatus("Impossible d'accéder à la caméra. Vérifiez les permissions.", true, statusFull);
            console.error(err);
        });
    };

    startBtn.addEventListener('click', startScanner);
    stopBtn.addEventListener('click', stopScanner);
    overlayClose?.addEventListener('click', stopScanner);
    window.addEventListener('beforeunload', stopScanner);
});
</script>
<style>
    .qr-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
    }
    .qr-overlay-inner {
        width: min(720px, 100%);
        max-width: 95vw;
    }
    .qr-reader-full {
        width: 100%;
        min-height: 240px;
        background: #111;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
</style>
{% endblock %}
