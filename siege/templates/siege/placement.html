{% extends 'game/base.html' %}
{% load siege_extras %}

{% block extra_head %}
<script src="https://cdn.tailwindcss.com"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-center mb-8 text-amber-500">Placement des Troupes</h1>

    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Unit Selection Panel -->
        <div class="w-full lg:w-1/3 bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-white">Vos Unités</h2>
            <div id="unit-container" class="grid grid-cols-2 gap-4">
                {% for unit_slug, count in units_available.items %}
                {% if count > 0 %}
                <div class="unit-card bg-gray-700 p-3 rounded cursor-move select-none" draggable="true"
                    data-slug="{{ unit_slug }}" data-count="{{ count }}">
                    <div class="text-3xl text-center mb-2">{{ units_config|get_item:unit_slug|get_attr:'emoji' }}</div>
                    <div class="text-center font-bold text-white">{{ units_config|get_item:unit_slug|get_attr:'name' }}
                    </div>
                    <div class="text-center text-sm text-gray-400">Restant: <span class="count">{{ count }}</span></div>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <div class="mt-8">
                <button id="confirm-placement"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Confirmer le Placement
                </button>
            </div>
        </div>

        <!-- Grid Board -->
        <div class="w-full lg:w-2/3 flex flex-col items-center gap-3">
            <div class="text-sm text-gray-400">
                <span class="inline-block bg-gray-700 px-2 py-1 rounded">Zone verte : placement autorisé</span>
                {% if opponent_layout %}<span class="inline-block bg-amber-700/60 px-2 py-1 rounded">Contours ambrés : positions connues de {{ opponent_name }}</span>{% endif %}
            </div>
            <div id="board" class="grid grid-cols-10 gap-1 bg-gray-900 p-2 rounded border-4 border-amber-700"
                style="width: 500px; height: 500px;">
                <!-- Cells generated by JS -->
            </div>
        </div>
    </div>
</div>

<style>
    .cell {
        background-color: #2d3748;
        border: 1px solid #4a5568;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        cursor: pointer;
    }

    .cell.valid-zone {
        background-color: #2f855a;
        /* Green tint for valid placement zone */
    }

    .cell.invalid-zone {
        background-color: #742a2a;
        /* Red tint for invalid zone */
        opacity: 0.5;
    }

    .cell:hover {
        border-color: #cbd5e0;
    }

    .placed-unit {
        cursor: grab;
    }

    .opponent-chip {
        position: absolute;
        bottom: 2px;
        right: 2px;
        background: rgba(245, 158, 11, 0.85);
        color: #0f172a;
        border-radius: 6px;
        padding: 2px 6px;
        font-size: 0.8rem;
        line-height: 1;
        pointer-events: none;
    }
</style>

<script>
    console.log("Placement script starting...");
    const battleId = {{ battle.id }};
    const isAttacker = {% if request.user == battle.attacker %}true{% else %} false{% endif %};
    const unitsConfig = {
        {% for slug, unit in units_config.items %}
    "{{ slug }}": { "emoji": "{{ unit.emoji }}", "name": "{{ unit.name }}" },
    {% endfor %}
    };

    let placedUnits = {}; // Key: "x,y", Value: slug
    let availableUnits = {
        {% for unit_slug, count in units_available.items %}
    "{{ unit_slug }}": {{ count }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    };
    const opponentLayoutEl = document.getElementById('opponent-layout');
    const opponentLayout = opponentLayoutEl ? JSON.parse(opponentLayoutEl.textContent || "{}") : {};
    const opponentName = "{{ opponent_name|default:'' }}";

    const board = document.getElementById('board');
    const unitContainer = document.getElementById('unit-container');
    const confirmBtn = document.getElementById('confirm-placement');

    // Initialize Board
    for (let y = 0; y < 10; y++) {
        for (let x = 0; x < 10; x++) {
            const cell = document.createElement('div');
            cell.classList.add('cell');
            cell.dataset.x = x;
            cell.dataset.y = y;
            cell.style.position = 'relative';

            // Attacker: Cols 0-2
            // Defender: Cols 7-9
            let isValid = false;
            if (isAttacker && x <= 2) isValid = true;
            if (!isAttacker && x >= 7) isValid = true;

            if (isValid) {
                cell.classList.add('valid-zone');
                cell.ondragover = allowDrop;
                cell.ondrop = drop;
                cell.onclick = removeUnit; // Click to remove
            } else {
                cell.classList.add('invalid-zone');
            }

            board.appendChild(cell);
        }
    }

    function renderOpponentLayout() {
        if (!opponentLayout || Object.keys(opponentLayout).length === 0) return;
        Object.entries(opponentLayout).forEach(([pos, slug]) => {
            const [x, y] = pos.split(',').map(v => parseInt(v, 10));
            const cell = Array.from(board.children).find(c => parseInt(c.dataset.x) === x && parseInt(c.dataset.y) === y);
            if (!cell) return;
            const chip = document.createElement('div');
            chip.className = 'opponent-chip';
            chip.title = `Placement de ${opponentName || "l'adversaire"}`;
            chip.textContent = unitsConfig[slug]?.emoji || '❔';
            cell.appendChild(chip);
        });
    }

    // Drag & Drop Logic
    let draggedType = null;

    document.querySelectorAll('.unit-card').forEach(card => {
        card.ondragstart = (e) => {
            draggedType = card.dataset.slug;
            if (availableUnits[draggedType] <= 0) {
                e.preventDefault();
            }
        };
    });

    function allowDrop(e) {
        e.preventDefault();
    }

    function drop(e) {
        e.preventDefault();
        const x = parseInt(e.target.dataset.x);
        const y = parseInt(e.target.dataset.y);
        const key = `${x},${y}`;

        if (placedUnits[key]) return; // Already occupied
        if (availableUnits[draggedType] > 0) {
            placeUnit(x, y, draggedType);
            updateCounts(draggedType, -1);
        }
    }

    function placeUnit(x, y, type) {
        const key = `${x},${y}`;
        placedUnits[key] = type;

        // Find cell
        const cell = Array.from(board.children).find(c => c.dataset.x == x && c.dataset.y == y);
        if (!cell) return;
        const tag = document.createElement('div');
        tag.textContent = unitsConfig[type].emoji;
        tag.classList.add('placed-unit');
        tag.style.position = 'relative';
        cell.innerHTML = '';
        cell.appendChild(tag);
        renderOpponentLayout();
    }

    function removeUnit(e) {
        const x = parseInt(e.target.dataset.x);
        const y = parseInt(e.target.dataset.y);
        const key = `${x},${y}`;

        if (placedUnits[key]) {
            const type = placedUnits[key];
            delete placedUnits[key];
            e.target.textContent = '';
            e.target.classList.remove('placed-unit');
            updateCounts(type, 1);
            renderOpponentLayout();
        }
    }

    function updateCounts(type, change) {
        availableUnits[type] += change;
        // Update UI
        const card = document.querySelector(`.unit-card[data-slug="${type}"]`);
        if (card) {
            card.querySelector('.count').textContent = availableUnits[type];
            if (availableUnits[type] <= 0) card.classList.add('opacity-50');
            else card.classList.remove('opacity-50');
        }
    }

    confirmBtn.onclick = async () => {
        // Check if all units are placed? Or at least one?
        if (Object.keys(placedUnits).length === 0) {
            alert("Placez au moins une unité !");
            return;
        }

        const response = await fetch(`/siege/battle/${battleId}/save_placement/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ layout: placedUnits })
        });

        const data = await response.json();
        if (data.status === 'ok') {
            window.location.href = `/siege/battle/${battleId}/room/`;
        } else {
            alert("Erreur: " + data.message);
        }
    };

    // Initial overlay render after grid is populated
    renderOpponentLayout();

</script>
{{ opponent_layout|json_script:"opponent-layout" }}
{% endblock %}
